<!DOCTYPE html>
<html lang="en">
  
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Maximum GFLOPS for an element-wise matrix multiplication</title>

  <meta name="author" content="daniel-e" />
  
  

  <link rel="alternate" type="application/rss+xml" title="daniel-e blog - Notes on machine learning, my activities on GitHub and more" href="/feed.xml" />

  
    
      <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />
    
    
  
  
    
      <link rel="stylesheet" href="/css/bootstrap.min.css" />
    
      <link rel="stylesheet" href="/css/main.css" />
    
  
  
  
    
	  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
    
	  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
    
  

    
  
  
  
  
  
  <link rel="stylesheet" href="/styles/default.css">
  <script src="/js/highlight.pack.js"></script>

  <!-- Facebook OpenGraph tags -->
  <meta property="og:title" content="Maximum GFLOPS for an element-wise matrix multiplication" />
  <meta property="og:type" content="website" />
  
  
  <meta property="og:url" content="http://daniel-e.github.io/2014-12-31-maximum-gflops-element-wise-matrix-multiplication/" />
  
  
  
  <meta property="og:image" content="http://daniel-e.github.io/img/avatar-icon.png" />
  
  
</head>


  <body>
  
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://daniel-e.github.io">daniel-e blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
	    
        <li>
		  <a href="/">Home</a>
		</li>
		
      </ul>
    </div>
	
	
	<div class="avatar-container">
	  <div class="avatar-img-border">
	    <a href="http://daniel-e.github.io ">
	      <img class="avatar-img" src="/img/avatar-icon.png" />
		</a>
	  </div>
	</div>
	
	
  </div>
</nav>  

    <div role="main" class="container main-content">
      <header class="header-post">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <div class="post-heading">
        <h1>Maximum GFLOPS for an element-wise matrix multiplication</h1>
        
        <span class="post-meta">Posted on December 31, 2014</span>
      </div>
     </div>
  </div>
</header>

<article>
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
	  <p>A question that often comes into my mind when doing computations with Octave or other numerical libraries is how good do they utilize the CPU. Recently I was interested in estimating the number of GFLOPS that can be achieved with Octave for the element-wise matrix multiplication. For an nxn matrix exactly n*n multiplications (by default double precision floating point operations) have to be executed. Hence, to estimate the number of GFLOPS we just need to measure the time that is required for that number of operations to be executed.</p>

<p>So, I wrote the following Octave script:</p>

<div class="highlight"><pre><code class="language-matlab" data-lang="matlab"><span class="mi">1</span><span class="p">;</span>

<span class="n">n</span> <span class="p">=</span> <span class="mi">4096</span><span class="p">;</span>
<span class="n">x</span> <span class="p">=</span> <span class="nb">rand</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="n">tic</span><span class="p">,</span> <span class="n">x</span> <span class="o">.*</span> <span class="n">x</span><span class="p">;</span>
<span class="n">y</span> <span class="p">=</span> <span class="n">toc</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&#39;GFLOPS: %f\n&#39;</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="n">y</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">);</span></code></pre></div>

<p>I have saved this script as “mult.m”, started Octave and executed the script:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">xx@host ~ <span class="nv">$ </span>octave -q
octave:1&gt; mult
<span class="nv">y</span> <span class="o">=</span> 0.081134
GFLOPS: 0.206784
octave:2&gt;</code></pre></div>

<p>For 4096 * 4096 = 16M multiplications the script took 0.08 seconds. According to the spec the theoretical GFLOPS of my four cores is 70.4. With Octave we can achieve just 0.2 GFLOPS for an element-wise matrix multiplication.</p>

<p><em>This is less than 1% of the theoretical peak performance!</em></p>

<p>To compute the element-wise matrix multiplication we must read at least once from main memory to read a source operand, perform the computation and write the result back to main memory. So one question is how much is that operation affected because of reading and writing memory?</p>

<p>I wrote a C++ program to measure the number of milliseconds required to copy 128MB from one memory location to another memory location. My assumption is that memcpy is well optimized and thus the fastest way to copy data so that I can use the time that memcpy requires for just copying as a lower bound for my further calculations.</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;iostream&gt;</span>
<span class="cp">#include &lt;chrono&gt;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
        <span class="cp">#define N (4096 * 4096 * 8)</span>
        <span class="kt">char</span><span class="o">*</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span> <span class="p">(</span><span class="n">N</span><span class="p">);</span>
        <span class="kt">char</span><span class="o">*</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">malloc</span> <span class="p">(</span><span class="n">N</span><span class="p">);</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
        <span class="k">auto</span> <span class="n">start</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
        <span class="k">auto</span> <span class="n">duration</span> <span class="o">=</span>
                <span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="p">(</span>
                        <span class="n">system_clock</span><span class="o">::</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
                <span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">duration</span><span class="p">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>I compiled the code and executed the binary several times:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">g++ -O3 memmv.cc --std<span class="o">=</span>c++11 -o memmv
xx@host ~ <span class="nv">$ </span>./memmv
72</code></pre></div>

<p>As we can see copying 128MB takes 72 milliseconds. Hence, the element-wise matrix multiplication with 16M double precision floating point operations must take at least 72 milliseconds. A maximum of 16M floating point operations in 72 milliseconds implies that we cannot perform more than 16M / 0.072 / 1e9 = 0.233 GFLOPS.</p>

<p>To summarize the results: I have shown how we can derive from experiments and calculations an upper bound for the maximum number of GFLOPS that can be executed for an element-wise double precision matrix multiplication by any numerical library. I have shown that the maximum number of GFLOPS that can be done especially on my system for an element-wise matrix multiplication is 0.233 GFLOPS and that Octave can do it with 0.2 GFLOPS which is approximately 86% of the theoretical peak. Although Octave is near to the optimum 0.2 GFLOPS are far away from the theoretical 17.6 GFLOPS for one CPU. The experiments show that the main reason for this comes from the limited memory bandwidth.</p>

<p>The code for these experiments can be found on Github: <a href="https://github.com/daniel-e/misc/tree/master/measure_flops">https://github.com/daniel-e/misc/tree/master/measure_flops</a></p>


	</div>
  </div>
</article>

<div class="row">
  <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <ul class="pager blog-pager">
      
      <li class="previous">
        <a href="/2014-12-27-octave-matrix-multiplication-performance-blas" data-toggle="tooltip" data-placement="top" title="Octave matrix multiplication performance for different BLAS implementations">&larr; Previous Post</a>
      </li>
      
      
      <li class="next">
        <a href="/2015-07-25-MNIST-handwritten-digits-for-Octave" data-toggle="tooltip" data-placement="top" title="MNIST database of handwritten digits for Octave">Next Post &rarr;</a>
      </li>
      
    </ul>
  </div>
</div>


<div class="row disqus-comments">
  <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">
	    var disqus_shortname = 'danieleblog';
	    // ensure that pages with query string get the same discussion
            var url_parts = window.location.href.split("?");
            var disqus_url = url_parts[0];	    
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>


  </div>
</div>


    </div>

    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="https://github.com/daniel-e" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		  
          <li>
            <a href="https://twitter.com/mldaniele" title="Twitter">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		  
          <li>
            <a href="mailto:git.daniele@gmail.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		  
		  
		  		  
        </ul>
        <p class="copyright text-muted">
		  daniel-e
		  &nbsp;&bull;&nbsp;
		  2015
		  
		  
		  &nbsp;&bull;&nbsp;
		  <a href="http://daniel-e.github.io">home</a>
		  
	    </p>
	        <!-- Please don't remove this, keep my open source work credited :) -->
		<p class="theme-by text-muted">
		  Theme by
		  <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
		</p>
      </div>
    </div>
  </div>
</footer>

  
    


  
	<script src="/js/jquery-1.11.2.min.js"></script>
  
	<script src="/js/bootstrap.min.js"></script>
  
	<script src="/js/main.js"></script>
  







	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-69423413-1', 'auto');
		ga('send', 'pageview');
	</script>
	<!-- End Google Analytics -->

  
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>
