<!DOCTYPE html>
<html lang="en">
  <!-- Beautiful Jekyll | MIT license | Copyright Dean Attali 2016 -->
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Nearest neighbor search in the Tiny Images dataset</title>

  <meta name="author" content="daniel-e" />

  

  <link rel="alternate" type="application/rss+xml" title="daniel-e blog - Notes on machine learning, security, my activities on GitHub and more" href="/feed.xml" />

  
    
      <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css" />
    
  

  
    
      <link rel="stylesheet" href="/css/bootstrap.min.css" />
    
      <link rel="stylesheet" href="/css/bootstrap-social.css" />
    
      <link rel="stylesheet" href="/css/main.css" />
    
  

  
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
    
  

  

  

  

    <!-- Facebook OpenGraph tags -->
  

  
  <meta property="og:title" content="Nearest neighbor search in the Tiny Images dataset" />
  

   
  <meta property="og:description" content="The Tiny Images dataset consists of 79,302,017 images, each being a 32x32 color RGB image. The images have been retrieved from the Internet from several image search engines, are stored in an uncompressed large binary file (227GB) so that each image can be easily accessed via random access and are...">
  


  <meta property="og:type" content="website" />

  
  <meta property="og:url" content="http://daniel-e.github.io/2016-01-05-nearest-neighbor-in-tiny-images-dataset/" />
  <link rel="canonical" href="http://daniel-e.github.io/2016-01-05-nearest-neighbor-in-tiny-images-dataset/" />
  

  
  

  <!-- Twitter summary cards -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@yourname" />
  <meta name="twitter:creator" content="@yourname" />

  
  <meta name="twitter:title" content="Nearest neighbor search in the Tiny Images dataset" />
  

  
  <meta name="twitter:description" content="The Tiny Images dataset consists of 79,302,017 images, each being a 32x32 color RGB image. The images have been retrieved from the Internet from several image search engines, are stored in an uncompressed large binary file (227GB) so that each image can be easily accessed via random access and are...">
  

  

</head>


  <body>
  
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://daniel-e.github.io">daniel-e blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
            
            





<a href="https://github.com/daniel-e/">GitHub</a>

          </li>
        
        
        
          <li class="navlinks-container">
            <a class="navlinks-parent" href="javascript:void(0)">Projects</a>
            <div class="navlinks-children">
              
                
                  
            





<a href="https://github.com/daniel-e/tetros">Tetros</a>

                
              
                
                  
            





<a href="https://github.com/daniel-e/stealthy">Stealthy</a>

                
              
            </div>
          </li>
        
        
      </ul>
    </div>

	

  </div>
</nav>


    <!-- TODO this file has become a mess, refactor it -->





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Nearest neighbor search in the Tiny Images dataset</h1>
		  
		  
		  
		  <span class="post-meta">Posted on January 5, 2016</span>
		  
        </div>
      </div>
    </div>
  </div>
</div>
</header>




<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

      <article role="main" class="blog-post">
        <p>The Tiny Images dataset consists of 79,302,017 images, each being a 32x32 color RGB image.
The images have been retrieved from the Internet from several image search engines,
are stored in an uncompressed large binary file (227GB) so that each image can be easily
accessed via random access and are loosely labeled with one of the 75,062 non-abstract
nouns in English as listed in the Wordnet lexical database. To download the file or to
get more details about the dataset you should visit
<a href="http://horatio.cs.nyu.edu/mit/tiny/data/index.html">this site</a>.</p>

<p>As shown in the paper “80 million tiny images: a large dataset for non-parametric object and scene recognition” 
which can be downloaded <a href="http://people.csail.mit.edu/billf/www/papers/80millionImages.pdf">here</a> this
dataset can be used for some quite
interesting tasks like scene detection, object detection and localization and image annotation.</p>

<p>In this blog post I will show you how to do a simple k-nearest neighbor search in this
database to search similar images to a given query image. The results are not very impressive but
the code can be used as a basis for further more sophisticated experiments.
The scripts and the source code of this post are available via
<a href="https://github.com/daniel-e/tinyimages/tree/master/knn">GitHub</a>.</p>

<p>First, lets have a look at the dataset. The script <code class="highlighter-rouge">mosaic.py</code> can be used to retrieve
images from the Timy Images dataset. The output of the script is an image where the tiny
images are organized in a grid. The first image is located in the first row and first column,
the second image is located in the first row and second column and so on (i.e. column-major
order). For example, the following command produces the image below which
contains 100 random images from the dataset in 20 columns und 5 rows. The random number
generator to generate the random numbers is seeded with the value 123 just to get
reproducible results.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">mosaic.py --db tiny_images.bin -o output.jpg -c 20 --seed 123</code></pre></figure>

<p><img src="/assets/tiny_images_knn/tinyimages-mosaic.jpg" alt="mosaic of tiny images dataset" /></p>

<p>If you want to extract images at specific positions you can append the position
of each image as an argument. For example, the following command retrieves the first 10
images of the Tiny Images dataset.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">mosaic.py --db tiny_images.bin -o output.jpg 0 1 2 3 4 5 6 7 8 9</code></pre></figure>

<h1 id="executing-a-search">Executing a search</h1>

<p>Doing a simple k-nearest neighbor search in the whole dataset is quite easy.
First, we need to perform
a preprocessing step to normalize the image. The query image must be scaled to 32x32
pixels and it must be a color image with the three color channels red, green and
blue. After the preprocessing step we can use the script <code class="highlighter-rouge">knn.py</code> to search for the
nearest neighbors.</p>

<p>The following commands demonstrate these steps for an image that is part of
this repository.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># preprocessing: rescale the query image</span>
convert -resize <span class="s1">'32x32!'</span> images/img.google.00000 queryimage.jpg
<span class="c"># perform the search</span>
knn.py --db tiny_images.bin -v queryimage.jpg | sort -g -S 2G | head -n 10000 &gt; scores.txt</code></pre></figure>

<p>The output of <code class="highlighter-rouge">knn.py</code> is one line for each image of the Tiny Images dataset. Each line
contains the score in the first column (i.e. the Euclidean distance between the query image
and the image in the dataset) and the position of the image in the Tiny Images
dataset.</p>

<p>In the example above we sort the output by the score and select only the first 10000 lines
which are the 10000 nearest neighbors. We can now inspect the nearest neighbors by creating
an image from the nearest neighbors.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># create a mosaic image for the first 100 nearest neighbours</span>
head -n 100 scores.txt | awk <span class="s1">'{print $2}'</span> | <span class="se">\</span>
	xargs mosaic.py --db tiny_images.bin -o output.jpg</code></pre></figure>

<p>Here are the results. For the following query image</p>

<p><img src="/assets/tiny_images_knn/query_image_for_nearest_neighbors.jpg" alt="nearest neighbors" /></p>

<p>these are the most similar images:</p>

<p><img src="/assets/tiny_images_knn/nearest_neighbors.jpg" alt="nearest neighbors" /></p>

<h2 id="performance">Performance</h2>

<p>On my workstation (i7-4790, Quadcore + Hyperthreading) it takes approximately
30 minutes for a single search. The disk is the bottleneck which can provide just
about 100MB/s for sequential I/O. To measure the maximum performance of the
<code class="highlighter-rouge">knn.py</code> script I have created a ramdisk with a capacity of 3GB and copied the
first 3GB of the Tiny Images dataset to that disk. Then, I did run the
<code class="highlighter-rouge">knn.py</code> script once again.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># create the ramdisk</span>
sudo mount -t tmpfs -o <span class="nv">size</span><span class="o">=</span>3g tmpfs /mnt/ramdisk/
<span class="c"># copy the first 3GB of the dataset to the ramdisk</span>
dd <span class="k">if</span><span class="o">=</span>tiny_images.bin <span class="nv">of</span><span class="o">=</span>/mnt/ramdisk/tiny_images.bin <span class="nv">bs</span><span class="o">=</span>1M
<span class="c"># run knn.py</span>
knn.py --db /mnt/ramdisk/tiny_images.bin -v queryimage.jpg &gt;/dev/null</code></pre></figure>

<p>With the data being read from main memory the maximum bandwidth of the
script is 390MB/s now. Thus, with a SSD the time required for a single
search could be reduced to about eight minutes.</p>

<p>Even without a SSD you could profit from further parallelism. If you want
to search the nearest neighbors for more than one image you could start
several <code class="highlighter-rouge">knn.py</code> scripts at the same time, one instance for each query
image. If one script reads the data
from the disk with about 100MB/s the other scripts can read the data from
the cache (&gt;3GB/s) and are not bounded by disk I/O anymore. With this
simple approach, we can run as many instances as required to get bounded
by CPU now. I have successfully tested this approach with four instances
running at the same time. I wasn’t bounded by disk I/O anymore and was able
to increase the throughput by a factor of about four.</p>

<h1 id="running-as-a-framework">Running as a framework</h1>

<p>The repository comes with example images in the <code class="highlighter-rouge">images/</code> directory and
a <code class="highlighter-rouge">Makefile</code> which can be used to search for the nearest neighbors for each
image in that directory. So, to run your own experiments for a set of images
you just have to put your images into the <code class="highlighter-rouge">images/</code> directory and run
the Makefile. But before doing this you have to set the
environment variable TINYIMAGE to the location of your Tiny Images
dataset. Then, you can execute the Makefile by running <code class="highlighter-rouge">make</code> on the
command line.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">export </span><span class="nv">TINYIMAGES</span><span class="o">=</span>&lt;location of tiny_images.bin&gt;
make</code></pre></figure>

<p>The results are stored in the directory <code class="highlighter-rouge">outputs</code> which contains the
following directories and files:</p>

<ul>
  <li><code class="highlighter-rouge">images_small/</code>: contains the normalized query images scaled to 32x32 pixels which are used for the knn search</li>
  <li><code class="highlighter-rouge">scores/</code>: contains the scores (i.e. the Euclidean distances) for each query image</li>
  <li><code class="highlighter-rouge">summary_images/</code>: contains for each query image an image with the top nearest neighbors</li>
  <li><code class="highlighter-rouge">summary.pdf</code>: a PDF created from the images in <code class="highlighter-rouge">summary_images</code></li>
</ul>

<p>Before running another experiment you should run <code class="highlighter-rouge">make clean</code> to remove
the data (i.e. the directory <code class="highlighter-rouge">outputs</code>) of the previous experiment or you
simply move the <code class="highlighter-rouge">outputs</code> directory to another location.</p>

      </article>

      

      
        <!-- Check if any share-links are active -->




<section id = "social-share-section">

  <!--- Share on Twitter -->
  
    <a href="https://twitter.com/intent/tweet?text=Nearest+neighbor+search+in+the+Tiny+Images+dataset+http://daniel-e.github.io/2016-01-05-nearest-neighbor-in-tiny-images-dataset/"
      class="btn btn-social-icon btn-twitter" title="Share on Twitter">
      <span class="fa fa-fw fa-twitter" aria-hidden="true"></span>
    </a>
  

  <!--- Share on Facebook -->
  
    <a href="https://www.facebook.com/sharer/sharer.php?u=http://daniel-e.github.io/2016-01-05-nearest-neighbor-in-tiny-images-dataset/"
      class="btn btn-social-icon btn-facebook" title="Share on Facebook">
      <span class="fa fa-fw fa-facebook" aria-hidden="true"></span>
    </a>
  

  <!--- Share on Google Plus -->
  

  <!--- Share on LinkedIn -->
  
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://daniel-e.github.io/2016-01-05-nearest-neighbor-in-tiny-images-dataset/"
      class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn">
      <span class="fa fa-fw fa-linkedin" aria-hidden="true"></span>
    </a>
  

</section>



      

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="/2015-12-30-a-simple-trick-if-sequential-io-is-the-bottleneck/" data-toggle="tooltip" data-placement="top" title="A simple trick if sequential I/O is the bottleneck">&larr; Previous Post</a>
        </li>
        
        
        <li class="next">
          <a href="/2016-10-21-doubleguard-detecting-intrusions-in-multi-tier-web-applications/" data-toggle="tooltip" data-placement="top" title="DoubleGuard Detecting Intrusions In Multi-tier Web Applications">Next Post &rarr;</a>
        </li>
        
      </ul>

      
        <div class="disqus-comments">
          
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">
	    var disqus_shortname = 'danieleblog';
	    /* ensure that pages with query string get the same discussion */
            var url_parts = window.location.href.split("?");
            var disqus_url = url_parts[0];	    
	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>


        </div>
      
    </div>
  </div>
</div>

    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="https://github.com/https://github.com/daniel-e/" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		  
      
		  
          <li>
            <a href="mailto:git.daniele@gmail.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		  
		  
		  
      
      
      
      
		  
        </ul>
        <p class="copyright text-muted">
		  daniel-e
		  &nbsp;&bull;&nbsp;
		  2016

		  
		  &nbsp;&bull;&nbsp;
		  <a href="http://daniel-e.github.io">home</a>
		  
	    </p>
	        <!-- Please don't remove this, keep my open source work credited :) -->
		<p class="theme-by text-muted">
		  Theme by
		  <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
		</p>
      </div>
    </div>
  </div>
</footer>

  
    






  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script>
      	if (typeof jQuery == 'undefined') {
      	  document.write('<script src="/js/jquery-1.11.2.min.js"></scr' + 'ipt>');
      	}
      </script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/js/bootstrap.min.js"></script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/js/main.js"></script>
    
  



	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-69423413-1', 'auto');
		ga('send', 'pageview');
	</script>
	<!-- End Google Analytics -->


  
  </body>
</html>
